Check Below trend.js file & trend.html file 
issue is there my function filterBy device type is not working.
and i want update filter by remark function with current remark from trend .js 

kindky check carefully and update both file 



trend.js

let deviceUptimeTimers = {};
let deviceDowntimeTimers = {};

function fetchDeviceData() {
    const selectedRegion = document.getElementById('region').value;
    fetch(`http://localhost/api/regions/details/${selectedRegion}`)
        .then(response => response.json())
        .then(regionData => {
            fetchDeviceHistory(regionData.details);
        })
        .catch(error => console.error('Error fetching device data:', error));
}



function fetchDeviceHistory(regionDetails) {
    fetch(`http://localhost/api/devices/history`)
        .then(response => response.json())
        .then(historyData => {
            populateDeviceTable(regionDetails, historyData);
            window.deviceHistoryData = historyData; // Store history for reuse
        })
        .catch(error => console.error('Error fetching device history:', error));
}





function populateDeviceTable(details, historyData) {
    const tableBody = document.getElementById('device-table').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ''; // Clear existing rows

    if (details) {
        ['cameras', 'archivers', 'controllers', 'servers'].forEach(deviceType => {
            details[deviceType]?.forEach(device => {
                const deviceIp = device.ip_address;
                const deviceName = device[deviceType.slice(0, -1) + 'name'];
                const deviceCategory = deviceType.slice(0, -1).toUpperCase();
                
                const deviceHistory = historyData[deviceIp] || [];
                const lastStatusEntry = deviceHistory.length > 0 ? deviceHistory[deviceHistory.length - 1] : null;
                const currentStatus = lastStatusEntry ? lastStatusEntry.status : "Unknown";

                // Create table row with borders for all cells
                const row = tableBody.insertRow();
                row.style.border = "1px solid black"; // Add border to row

                row.innerHTML = `
                    <td>${deviceIp}</td>
                    <td>${deviceName}</td>
                    <td>${deviceCategory}</td>
                    <td id="uptime-${deviceIp}">0h/0m/0s</td>
                    <td id="downtime-count-${deviceIp}">0</td>
                    <td id="downtime-${deviceIp}">0h/0m/0s</td>
                    <td><button onclick="openDeviceHistory('${deviceIp}')">View History</button></td>
                    <td id="remark-${deviceIp}">Device working properly</td>
                `;

                // Set text color based on status (Online = Green, Offline = Red)
                const color = currentStatus === "Online" ? "green" : "red";
                row.style.color = color; // Change text color to green (online) or red (offline)

                if (currentStatus === "Online") {
                    startUptime(deviceIp, deviceHistory);
                } else {
                    startDowntime(deviceIp, deviceHistory);
                }

                // Update remarks based on device status and conditions
                updateRemarks(deviceIp, deviceHistory);
            });
        });
    } else {
        console.error('No details found in the response');
    }
}

function startUptime(deviceIp, history) {
    clearInterval(deviceDowntimeTimers[deviceIp]);
    let lastOnlineEntry = history.filter(entry => entry.status === "Online").pop();
    
    if (!lastOnlineEntry) return;
    
    let startTime = new Date(lastOnlineEntry.timestamp).getTime();
    deviceUptimeTimers[deviceIp] = setInterval(() => {
        let elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById(`uptime-${deviceIp}`).innerText = formatDuration(elapsedTime);
    }, 1000);
}

// **Updated startDowntime function to fix current offline detection**
function startDowntime(deviceIp, history) {
    clearInterval(deviceUptimeTimers[deviceIp]);
    let lastOfflineEntry = history.filter(entry => entry.status === "Offline").pop();

    if (!lastOfflineEntry) return;
    
    let startTime = new Date(lastOfflineEntry.timestamp).getTime();
    deviceDowntimeTimers[deviceIp] = setInterval(() => {
        let elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById(`downtime-${deviceIp}`).innerText = formatDuration(elapsedTime);
        updateDowntimeCount(deviceIp, history);
    }, 1000);
}




// **Fix Downtime Count and Remarks Update (with proper filtering)**
function updateDowntimeCount(deviceIp, history) {
    let downtimeEntries = history.filter(entry => entry.status === "Offline");

    // Only count downtimes that last more than 5 minutes, except for servers
    let filteredDowntimeEntries = downtimeEntries.filter((entry, index, arr) => {
        if (deviceType === "SERVER") return true; // Always count downtime for servers
        if (index === 0) return true; // Always keep the first entry

        let previousEntry = arr[index - 1];
        let duration = (new Date(entry.timestamp) - new Date(previousEntry.timestamp)) / 1000;
        return duration >= 300; // 300 seconds = 5 minutes
    });

    let downtimeCount = filteredDowntimeEntries.length;
    
    let downtimeElement = document.getElementById(`downtime-count-${deviceIp}`);
    if (downtimeElement) {
        downtimeElement.innerText = downtimeCount;
    }

    // Update remarks based on downtime count and total downtime
    let remarkElement = document.getElementById(`remark-${deviceIp}`);
    if (remarkElement) {
        if (downtimeCount === 0) {
            remarkElement.innerText = "Device is Online.";
        } else if (downtimeCount >= 3) {
            remarkElement.innerText = `Device is Online, but it had ${downtimeCount} offline occurrences. Needs repair!`;
        } else {
            remarkElement.innerText = `Device is Online, but it had ${downtimeCount} offline occurrences.`;
        }
    }
}





// Fix for updateRemarks function to prioritize current status and handle downtime properly
function updateRemarks(deviceIp, history, deviceType) {
    let downtimeEntries = history.filter(entry => entry.status === "Offline");

    // Filter downtimes that lasted more than 5 minutes (except for servers)
    let filteredDowntimeEntries = downtimeEntries.filter((entry, index, arr) => {
        if (deviceType === "SERVER") return true; // Always count downtime for servers
        if (index === 0) return true; // Always keep the first entry

        let previousEntry = arr[index - 1];
        let duration = (new Date(entry.timestamp) - new Date(previousEntry.timestamp)) / 1000;
        return duration >= 300; // 300 seconds = 5 minutes
    });

    let downtimeCount = filteredDowntimeEntries.length;
    let totalDowntimeDuration = filteredDowntimeEntries.reduce((total, entry) => total + (new Date() - new Date(entry.timestamp)), 0) / 1000;
    totalDowntimeDuration = Math.floor(totalDowntimeDuration / 86400); // Convert to days

    const remarkElement = document.getElementById(`remark-${deviceIp}`);
    let lastStatus = history.length > 0 ? history[history.length - 1].status : "Unknown";

    // **Fix: Ensure the remark reflects the correct current status**
    if (lastStatus === "Offline") {
        // Fix to show "Offline" as the current status over any previous occurrence
        if (downtimeCount >= 3 || totalDowntimeDuration > 2) {
            remarkElement.innerText = `Device is Offline, needs repair.`;
        } else {
            remarkElement.innerText = `Device is Offline.`;
        }
    } else if (lastStatus === "Online") {
        // Ensure that remarks reflect the device is Online and its downtime history
        if (downtimeCount >= 3 || totalDowntimeDuration > 2) {
            remarkElement.innerText = `Device is Online, needs repair.`;
        } else if (downtimeCount > 0) {
            remarkElement.innerText = `Device is Online, but it had ${downtimeCount} offline occurrences.`;
        } else {
            remarkElement.innerText = `Device is Online.`;
        }
    } else {
        remarkElement.innerText = `Device status unknown.`;
    }

    // **Fix: Ensure downtime count is properly updated**
    let downtimeElement = document.getElementById(`downtime-count-${deviceIp}`);
    if (downtimeElement) {
        downtimeElement.innerText = downtimeCount;
    }
}



function formatDuration(seconds) {
    let days = Math.floor(seconds / 86400); // 1 day = 86400 seconds
    let hours = Math.floor((seconds % 86400) / 3600);
    let minutes = Math.floor((seconds % 3600) / 60);
    let secs = seconds % 60;

    let result = [];
    if (days > 0) result.push(`${days}d`);
    if (hours > 0 || days > 0) result.push(`${hours}h`);
    if (minutes > 0 || hours > 0 || days > 0) result.push(`${minutes}m`);
    result.push(`${secs}s`); // Always show seconds

    return result.join('/');
}



function openDeviceHistory(deviceIp) {
    if (!window.deviceHistoryData) {
        console.error("Device history data not loaded.");
        return;
    }
    const history = window.deviceHistoryData[deviceIp] || [];
    displayDeviceHistory(history);
    document.getElementById('device-history-modal').style.display = 'block';
}


function displayDeviceHistory(history) {
    const historyContainer = document.getElementById('device-history');
    historyContainer.innerHTML = '';

    if (history.length > 0) {
        let lastOfflineTime = null; // To store the last "Offline" timestamp

        for (let i = 0; i < history.length; i++) {
            const entry = history[i];
            const date = new Date(entry.timestamp);
            const formattedDate = date.toDateString(); // Example: "Wed Mar 19 2025"
            const day = date.toLocaleDateString(undefined, { weekday: 'long' }); // Example: "Wednesday"
            const time = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' }); // Example: "12:53:16 AM"
            
            let downtimeText = '';

            // Check if the last entry was "Offline" and the current entry is "Online"
            if (lastOfflineTime && entry.status === "Online") {
                const downtimeSeconds = Math.floor((date - lastOfflineTime) / 1000); // Calculate downtime duration
                downtimeText = `<span style="color: red;"> (Downtime: ${formatDuration(downtimeSeconds)})</span>`;
                lastOfflineTime = null; // Reset after calculating downtime
            }

            // Store "Offline" timestamp to compare with the next "Online"
            if (entry.status === "Offline") {
                lastOfflineTime = date;
            }

            // Create entry div
            const entryDiv = document.createElement('div');
            entryDiv.innerHTML = `<p><strong>${day}, ${formattedDate}, ${time}</strong> - ${entry.status} ${downtimeText}</p>`;

            historyContainer.appendChild(entryDiv);
        }
    } else {
        historyContainer.innerHTML = '<p>No history available</p>';
    }
}


function closeHistoryModal() {
    document.getElementById('device-history-modal').style.display = 'none';
}

function filterData() {
    const selectedType = document.getElementById('device-type').value;
    const selectedRemark = document.getElementById('remark-filter').value;
    const table = document.getElementById('device-table');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let row of rows) {
        const type = row.cells[2].textContent;
        const remark = row.cells[7].textContent;

        if ((selectedType === "all" || type === selectedType) &&
            (selectedRemark === "all" || remark === selectedRemark)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}

document.addEventListener("DOMContentLoaded", function () {
    document.getElementById('region').addEventListener('change', fetchDeviceData);
    fetchDeviceData(); // Initial load
});






trend.html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Sidebar -->
    <div id="sidebar">
       button id="menu-btn" onclick="toggleSidebar()">☰</button>
        <div id="sidebar-content">
            <button onclick="window.location.href='index.html'">Back to Dashboard</button>

           
            <label for="region">Select Region:</label>
            <select id="region" onchange="fetchDeviceData()">
                <option value="apac">APAC</option>
                <option value="emea">EMEA</option>
                <option value="laca">LACA</option>
                <option value="namer">NAMER</option>
            </select>

            <label for="device-type">Filter by Device Type:</label>
            <select id="device-type" onchange="filterData()">
                <option value="ALL">All</option>
                <option value="CONTROLLER">Controller</option>

                <option value="ARCHIVER">Archiver</option>

                <option value="CAMERA">Camera</option>

                <option value="SERVER">Server</option>
                
            </select>

            <label for="remark-filter">Filter by Remark:</label>

            <select id="remark-filter" onchange="filterData()">
                <option value="ALL">All</option>
                <option value="Device needs repair">Device needs repair</option>
                <option value="Device is online, its downtime count is 0">Device is online</option>
                <option value="Device working properly">Device working properly</option>
            </select>
            
        </div>
    </div>


    <h1>Device Trend Report</h1>

    <div class="container">
        <table id="device-table">
            <thead>
                <tr>
                    <th>Device IP</th>
                    <th>Device Name</th>
                    <th>Device Type</th>
                    <th>Uptime Duration</th>
                    <th>Downtime Count</th>
                    <th>Downtime Duration</th>
                    <th>Details</th>
                    <th>Remark</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Device History Modal -->
    <div id="device-history-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2>Device History</h2>
            <div id="device-history"></div>
        </div>
    </div>
    
<script>
    document.addEventListener("DOMContentLoaded" , function (){
        fetchDeviceData();
    });
</script>
    <script src="trend.js"></script>


   <!-- Footer -->
   <footer class="footer">
    <img src="images/FooterLogo.png" alt="Company Logo" class="footer-logo">
    <p>&copy;2025 VisionWatch | Powered by <strong>Western Union Services India Pvt Ltd.</strong></p>
    <p>Contact: 
        <a href="mailto:gsoc-globalsecurityoperationcenter.sharedmailbox@westernunion.com">gsoc-globalsecurityoperationcenter.sharedmailbox@westernunion.com</a> | 
        <a href="tel:+91 20 67632394">+91 2067632394</a>
    </p>
</footer>

</body>
</html>

</body>
</html>



