fetch(`http://localhost/api/regions/details/${selectedRegion}`)
    .then(response => response.json())
    .then(regionData => {
        const details = regionData.details;

        // Filter out only the devices that should be visible on the UI
        const visibleDevices = [
            ...details.cameras || [],
            ...details.archivers || [],
            ...details.controllers || [],
            ...details.servers || []
        ].filter(device => device.status === "Online" && device.visible === true);  // Ensure devices are visible in the UI

        // Calculate the counts of visible devices
        const totalDevices = visibleDevices.length;
        const totalOnlineDevices = visibleDevices.filter(device => device.status === "Online").length;
        const totalCameras = details.cameras?.filter(device => device.status === "Online" && device.visible === true).length || 0;
        const totalControllers = details.controllers?.filter(device => device.status === "Online" && device.visible === true).length || 0;
        const totalArchivers = details.archivers?.filter(device => device.status === "Online" && device.visible === true).length || 0;
        const totalServers = details.servers?.filter(device => device.status === "Online" && device.visible === true).length || 0;

        // Update UI with the visible device counts
        document.getElementById("total-devices").innerText = `Total Devices: ${totalDevices}`;
        document.getElementById("total-online").innerText = `Total Online Devices: ${totalOnlineDevices}`;
        document.getElementById("total-cameras").innerText = `Total Cameras: ${totalCameras}`;
        document.getElementById("total-controllers").innerText = `Total Controllers: ${totalControllers}`;
        document.getElementById("total-archivers").innerText = `Total Archivers: ${totalArchivers}`;
        document.getElementById("total-servers").innerText = `Total Servers: ${totalServers}`;
        
        // Call the function for fetching device history
        fetchDeviceHistory(regionData.details);
    })
    .catch(error => console.error('Error fetching device data:', error));
