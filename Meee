<div id="loading" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 5px;">
    Loading...
</div>



let deviceUptimeTimers = {};
let deviceDowntimeTimers = {};

document.addEventListener("DOMContentLoaded", function () {
    document.getElementById('region').addEventListener('change', fetchDeviceData);
    document.getElementById('device-type').addEventListener('change', filterData);
    document.getElementById('remark-filter').addEventListener('change', filterData);

    fetchDeviceData(); // Initial data load
});

function fetchDeviceData() {
    const selectedRegion = document.getElementById('region').value;
    showLoading(); // Show loading animation

    fetch(`http://localhost/api/regions/details/${selectedRegion}`)
        .then(response => response.json())
        .then(regionData => {
            fetchDeviceHistory(regionData.details);
        })
        .catch(error => {
            console.error('Error fetching device data:', error);
            hideLoading();
        });
}

function fetchDeviceHistory(regionDetails) {
    fetch(`http://localhost/api/devices/history`)
        .then(response => response.json())
        .then(historyData => {
            populateDeviceTable(regionDetails, historyData);
            hideLoading(); // Hide loading animation after data is loaded
        })
        .catch(error => {
            console.error('Error fetching device history:', error);
            hideLoading();
        });
}

function populateDeviceTable(details, historyData) {
    const tableBody = document.getElementById('device-table').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ''; // Clear existing rows

    if (details) {
        ['cameras', 'archivers', 'controllers', 'servers'].forEach(deviceType => {
            details[deviceType]?.forEach(device => {
                const deviceIp = device.ip_address;
                const deviceName = device[deviceType.slice(0, -1) + 'name'];
                const deviceCategory = deviceType.slice(0, -1).toUpperCase();

                const deviceHistory = historyData[deviceIp] || [];
                const lastStatusEntry = deviceHistory.length > 0 ? deviceHistory[deviceHistory.length - 1] : null;
                const currentStatus = lastStatusEntry ? lastStatusEntry.status : "Unknown";

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${deviceIp}</td>
                    <td>${deviceName}</td>
                    <td>${deviceCategory}</td>
                    <td id="uptime-${deviceIp}">0h/0m/0s</td>
                    <td id="downtime-count-${deviceIp}">0</td>
                    <td id="downtime-${deviceIp}">0h/0m/0s</td>
                    <td><button onclick="openDeviceHistory('${deviceIp}')">View History</button></td>
                    <td id="remark-${deviceIp}">Device working properly</td>
                `;

                row.style.color = currentStatus === "Online" ? "green" : "red"; // Set text color

                tableBody.appendChild(row);

                if (currentStatus === "Online") {
                    startUptime(deviceIp, deviceHistory);
                } else {
                    startDowntime(deviceIp, deviceHistory);
                }

                updateRemarks(deviceIp, deviceHistory);
            });
        });

        filterData(); // Apply filters after populating table
    } else {
        console.error('No details found in the response');
    }
}

function filterData() {
    const selectedType = document.getElementById('device-type').value;
    const selectedRemark = document.getElementById('remark-filter').value;
    const rows = document.getElementById('device-table').getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let row of rows) {
        const type = row.cells[2].textContent;
        const remark = row.cells[7].textContent;

        if ((selectedType === "all" || type === selectedType) &&
            (selectedRemark === "all" || remark.includes(selectedRemark))) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}

function showLoading() {
    const loadingDiv = document.getElementById("loading");
    if (loadingDiv) {
        loadingDiv.style.display = "block"; // Show loading
    }
}

function hideLoading() {
    const loadingDiv = document.getElementById("loading");
    if (loadingDiv) {
        loadingDiv.style.display = "none"; // Hide loading
    }
}

function startUptime(deviceIp, history) {
    clearInterval(deviceDowntimeTimers[deviceIp]);
    let lastOnlineEntry = history.filter(entry => entry.status === "Online").pop();

    if (!lastOnlineEntry) return;

    let startTime = new Date(lastOnlineEntry.timestamp).getTime();
    deviceUptimeTimers[deviceIp] = setInterval(() => {
        let elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById(`uptime-${deviceIp}`).innerText = formatDuration(elapsedTime);
    }, 1000);
}

function startDowntime(deviceIp, history) {
    clearInterval(deviceUptimeTimers[deviceIp]);
    let lastOfflineEntry = history.filter(entry => entry.status === "Offline").pop();

    if (!lastOfflineEntry) return;

    let startTime = new Date(lastOfflineEntry.timestamp).getTime();
    deviceDowntimeTimers[deviceIp] = setInterval(() => {
        let elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById(`downtime-${deviceIp}`).innerText = formatDuration(elapsedTime);
        updateDowntimeCount(deviceIp, history);
    }, 1000);
}

function updateDowntimeCount(deviceIp, history) {
    let downtimeCount = history.filter(entry => entry.status === "Offline").length;
    document.getElementById(`downtime-count-${deviceIp}`).innerText = downtimeCount;

    if (downtimeCount > 3) {
        document.getElementById(`remark-${deviceIp}`).innerText = "Device needs repair";
    }
}

function updateRemarks(deviceIp, history) {
    let downtimeCount = history.filter(entry => entry.status === "Offline").length;
    let totalDowntimeDuration = history.filter(entry => entry.status === "Offline")
                                       .reduce((total, entry) => total + (new Date() - new Date(entry.timestamp)), 0) / 1000;

    totalDowntimeDuration = Math.floor(totalDowntimeDuration / 3600); // Convert to hours

    const remarkElement = document.getElementById(`remark-${deviceIp}`);

    if (downtimeCount > 5 && totalDowntimeDuration > 5) {
        remarkElement.innerText = `Device is offline, its downtime count is ${downtimeCount}, and Device needs repair.`;
    } else if (history.length > 0 && history[history.length - 1].status === "Online") {
        remarkElement.innerText = `Device is online, its downtime count is ${downtimeCount}.`;
    }
}

function formatDuration(seconds) {
    let days = Math.floor(seconds / 86400);
    let hours = Math.floor((seconds % 86400) / 3600);
    let minutes = Math.floor((seconds % 3600) / 60);
    let secs = seconds % 60;

    let result = [];
    if (days > 0) result.push(`${days}d`);
    if (hours > 0 || days > 0) result.push(`${hours}h`);
    if (minutes > 0 || hours > 0 || days > 0) result.push(`${minutes}m`);
    result.push(`${secs}s`);

    return result.join('/');
}

function openDeviceHistory(ipAddress) {
    fetch(`http://localhost/api/devices/history`)
        .then(response => response.json())
        .then(data => {
            displayDeviceHistory(data[ipAddress] || []);
        })
        .catch(error => console.error('Error fetching device history:', error));

    document.getElementById('device-history-modal').style.display = 'block';
}

function displayDeviceHistory(history) {
    const historyContainer = document.getElementById('device-history');
    historyContainer.innerHTML = history.length > 0 ? history.map(entry =>
        `<p><strong>${new Date(entry.timestamp).toLocaleString()}</strong> - ${entry.status}</p>`
    ).join('') : '<p>No history available</p>';
}

function closeHistoryModal() {
    document.getElementById('device-history-modal').style.display = 'none';
}
