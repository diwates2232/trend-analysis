<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Status Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Device Status Dashboard</h1>

    <!-- Filters -->
    <div>
        <label for="regionFilter">Filter by Region:</label>
        <select id="regionFilter">
            <option value="global">Global</option>
            <option value="apac">APAC</option>
            <option value="laca">LACA</option>
            <option value="emea">EMEA</option>
            <option value="namer">NAMER</option>
        </select>

        <label for="categoryFilter">Filter by Category:</label>
        <select id="categoryFilter">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
        </select>

        <label for="deviceTypeFilter">Filter by Device Type:</label>
        <select id="deviceTypeFilter">
            <option value="All">All</option>
            <option value="Camera">Camera</option>
            <option value="Archiver">Archiver</option>
            <option value="Controller">Controller</option>
            <option value="Server">Server</option>
        </select>
    </div>

    <!-- Device Table -->
    <table id="deviceTable">
        <thead>
            <tr>
                <th>Sr. No.</th>
                <th>Device IP</th>
                <th>Device Name</th>
                <th>Device Current Status</th>
                <th>Device History</th>
                <th>Device Category</th>
            </tr>
        </thead>
        <tbody id="device-list">
            <!-- Device list will be populated here -->
        </tbody>
    </table>

    <script src="script.js"></script>
</body>
</html>






document.addEventListener("DOMContentLoaded", function () {
    const regionFilter = document.getElementById("regionFilter");
    const categoryFilter = document.getElementById("categoryFilter");
    const deviceTypeFilter = document.getElementById("deviceTypeFilter");
    const deviceList = document.getElementById("device-list");

    // Check if elements are loaded before using them
    if (!deviceList || !regionFilter || !categoryFilter || !deviceTypeFilter) {
        console.error("One or more required elements are missing in the DOM.");
        return;
    }

    async function fetchDevices(region = "global") {
        try {
            const response = await fetch(`http://localhost/api/regions/details/${region}`);
            if (!response.ok) throw new Error("Failed to fetch data");

            const data = await response.json();
            console.log("Devices Data:", data);

            updateDeviceList(data);
        } catch (error) {
            console.error("Error fetching devices:", error);
        }
    }

    function updateDeviceList(data) {
        if (!deviceList) {
            console.error("Missing device list element.");
            return;
        }

        let filteredDevices = filterDevices(data.details);

        // Clear the existing list
        deviceList.innerHTML = "";

        if (filteredDevices.length === 0) {
            deviceList.innerHTML = "<tr><td colspan='6'>No devices match the filter criteria.</td></tr>";
            return;
        }

        filteredDevices.forEach((device, index) => {
            const tr = document.createElement("tr");

            // Determine device category based on conditions
            let category = "Low";
            const offlineCount = device.history.filter(entry => entry.status === "Offline").length;
            const downtime = calculateDowntime(device.history);
            if (offlineCount > 3 || downtime > 120) {
                category = "Medium";
            }
            if (offlineCount >= 5 || downtime > 240) {
                category = "High";
            }

            // Create table row for each device
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${device.ip_address}</td>
                <td>${device.name}</td>
                <td style="color:${device.status === 'Online' ? 'green' : 'red'}">${device.status}</td>
                <td><button onclick="viewDeviceHistory(${device.id})">View History</button></td>
                <td>${category}</td>
            `;
            deviceList.appendChild(tr);
        });
    }

    function filterDevices(devices) {
        const region = regionFilter.value;
        const category = categoryFilter.value;
        const deviceType = deviceTypeFilter.value;

        return devices.filter(device => {
            // Filter by region
            if (device.region !== region && region !== "global") {
                return false;
            }

            // Filter by category
            if (category !== "Low" && category !== "Medium" && category !== "High") {
                return false;
            }

            // Filter by device type (Camera, Archiver, etc.)
            if (deviceType !== "All" && device.type !== deviceType) {
                return false;
            }

            return true;
        });
    }

    function calculateDowntime(history) {
        let totalDowntime = 0;
        for (let i = 0; i < history.length - 1; i++) {
            if (history[i].status === "Offline" && history[i + 1].status === "Online") {
                let offlineTime = new Date(history[i].timestamp);
                let onlineTime = new Date(history[i + 1].timestamp);
                totalDowntime += (onlineTime - offlineTime) / (1000 * 60); // Convert to minutes
            }
        }
        return totalDowntime;
    }

    function viewDeviceHistory(deviceId) {
        // Display device history (daily, weekly, monthly)
        const historyData = getDeviceHistory(deviceId);
        const historyContainer = document.createElement("div");

        historyContainer.innerHTML = `
            <h3>Device History</h3>
            <button onclick="showDeviceHistory('daily')">Daily</button>
            <button onclick="showDeviceHistory('weekly')">Weekly</button>
            <button onclick="showDeviceHistory('monthly')">Monthly</button>
            <div id="deviceHistoryContent"></div>
        `;

        document.body.appendChild(historyContainer);
        showDeviceHistory('daily', historyData);
    }

    function showDeviceHistory(timeFrame) {
        const historyContent = document.getElementById("deviceHistoryContent");

        // Logic to display history based on timeframe
        historyContent.innerHTML = `Showing ${timeFrame} data for the device.`;

        // Fetch or filter data according to daily, weekly, or monthly
    }

    fetchDevices();
});










document.addEventListener("DOMContentLoaded", function () {
    const regionFilter = document.getElementById("regionFilter");
    const summaryElement = document.getElementById("summary");
    const deviceList = document.getElementById("device-list");

    // Check if elements are loaded before using them
    if (!summaryElement || !deviceList || !regionFilter) {
        console.error("One or more required elements are missing in the DOM.");
        return;
    }

    async function fetchSummary(region = "global") {
        try {
            const response = await fetch(`http://localhost/api/regions/details/${region}`);
            if (!response.ok) throw new Error("Failed to fetch data");

            const data = await response.json();
            console.log("Summary Data:", data);

            updateSummary(data);
        } catch (error) {
            console.error("Error fetching summary:", error);
            if (summaryElement) summaryElement.textContent = "Error loading summary.";
        }
    }

    function updateSummary(data) {
        if (!summaryElement || !deviceList) {
            console.error("Missing UI elements.");
            return;
        }

        let offlineDevices = [];
        let categorizedDevices = {
            Low: [],
            Medium: [],
            High: []
        };

        // Iterate through devices and classify their status correctly
        ["cameras", "archivers", "controllers", "servers"].forEach(type => {
            if (data.details[type]) {
                data.details[type].forEach(device => {
                    // Check the current status of the device and mark accordingly
                    let status = device.status;  // Assuming `status` is the field containing "Online" or "Offline"
                    if (status === "Offline" || device.history.length > 1) {
                        offlineDevices.push(device);
                        categorizeDevice(device, categorizedDevices);
                    }
                });
            }
        });

        summaryElement.innerHTML = `
            <strong>Total Offline Devices:</strong> ${offlineDevices.length} <br>
            <strong>Low Risk:</strong> ${categorizedDevices.Low.length} <br>
            <strong>Medium Risk:</strong> ${categorizedDevices.Medium.length} <br>
            <strong>High Risk:</strong> ${categorizedDevices.High.length}
        `;

        updateDeviceList(offlineDevices);
    }

    function categorizeDevice(device, categorizedDevices) {
        let offlineCount = device.history.filter(entry => entry.status === "Offline").length;
        let recentOfflineDuration = calculateDowntime(device.history);

        if (offlineCount > 3 || recentOfflineDuration > 120) {
            categorizedDevices.Low.push(device);
        }

        if (offlineCount >= 5 || recentOfflineDuration > 240) {
            categorizedDevices.Medium.push(device);
        }

        if (offlineCount > 7 || recentOfflineDuration > 600) {
            categorizedDevices.High.push(device);
        }
    }

    function calculateDowntime(history) {
        let totalDowntime = 0;
        for (let i = 0; i < history.length - 1; i++) {
            if (history[i].status === "Offline" && history[i + 1].status === "Online") {
                let offlineTime = new Date(history[i].timestamp);
                let onlineTime = new Date(history[i + 1].timestamp);
                totalDowntime += (onlineTime - offlineTime) / (1000 * 60); // Convert to minutes
            }
        }
        return totalDowntime;
    }

    function updateDeviceList(devices) {
        if (!deviceList) return;

        deviceList.innerHTML = "";
        if (devices.length === 0) {
            deviceList.innerHTML = "<li>No offline devices currently.</li>";
            return;
        }

        devices.forEach(device => {
            const li = document.createElement("li");
            let status = device.status === "Online" ? "Online" : "Offline"; // Make sure status is properly set
            li.innerHTML = `
                <strong>${device.archivername || device.cameraname || device.controllername || device.servername}</strong> <br>
                IP: ${device.ip_address} <br>
                Status: <span style="color:${status === 'Online' ? 'green' : 'red'};">${status}</span>
            `;
            deviceList.appendChild(li);
        });
    }

    regionFilter.addEventListener("change", function () {
        fetchSummary(regionFilter.value);
    });

    fetchSummary();
    setInterval(() => fetchSummary(regionFilter.value), 60000); // Auto-refresh every 60 seconds
});












document.addEventListener("DOMContentLoaded", function () {
    const regionFilter = document.getElementById("regionFilter");
    const summaryElement = document.getElementById("summary");
    const deviceList = document.getElementById("device-list");

    // Check if elements are loaded before using them
    if (!summaryElement || !deviceList || !regionFilter) {
        console.error("One or more required elements are missing in the DOM.");
        return;
    }

    // Fetch and update the device status and summary data
    async function fetchLiveDeviceStatus(region = "global") {
        try {
            const response = await fetch(`http://localhost/api/devices/status/${region}`);
            if (!response.ok) throw new Error("Failed to fetch device status");

            const data = await response.json();
            console.log("Live Device Status Data:", data);

            updateDeviceList(data);
            updateSummary(data);
        } catch (error) {
            console.error("Error fetching live device status:", error);
            if (summaryElement) summaryElement.textContent = "Error loading device status.";
        }
    }

    // Update device list on the frontend
    function updateDeviceList(data) {
        if (!deviceList) return;

        deviceList.innerHTML = "";

        const devices = [...(data.cameras || []), ...(data.archivers || [])]; // Combine cameras and archivers if needed

        if (devices.length === 0) {
            deviceList.innerHTML = "<li>No devices available.</li>";
            return;
        }

        devices.forEach(device => {
            const li = document.createElement("li");
            li.innerHTML = `
                <strong>${device.cameraname || device.archivername}</strong> <br>
                IP: ${device.ip_address} <br>
                Status: <span style="color:${device.status === 'Offline' ? 'red' : 'green'};">${device.status}</span>
            `;
            deviceList.appendChild(li);
        });
    }

    // Update summary data
    function updateSummary(data) {
        if (!summaryElement) return;

        let offlineDevices = 0;
        let categorizedDevices = {
            Low: [],
            Medium: [],
            High: []
        };

        const devices = [...(data.cameras || []), ...(data.archivers || [])];

        devices.forEach(device => {
            if (device.status === "Offline") {
                offlineDevices++;
                categorizeDevice(device, categorizedDevices);
            }
        });

        summaryElement.innerHTML = `
            <strong>Total Offline Devices:</strong> ${offlineDevices} <br>
            <strong>Low Risk:</strong> ${categorizedDevices.Low.length} <br>
            <strong>Medium Risk:</strong> ${categorizedDevices.Medium.length} <br>
            <strong>High Risk:</strong> ${categorizedDevices.High.length}
        `;
    }

    // Categorize devices based on status duration or other criteria
    function categorizeDevice(device, categorizedDevices) {
        let offlineCount = device.history.filter(entry => entry.status === "Offline").length;
        let recentOfflineDuration = calculateDowntime(device.history);

        if (offlineCount > 3 || recentOfflineDuration > 120) {
            categorizedDevices.Low.push(device);
        }

        if (offlineCount >= 5 || recentOfflineDuration > 240) {
            categorizedDevices.Medium.push(device);
        }

        if (offlineCount > 7 || recentOfflineDuration > 600) {
            categorizedDevices.High.push(device);
        }
    }

    // Calculate total downtime in minutes
    function calculateDowntime(history) {
        let totalDowntime = 0;
        for (let i = 0; i < history.length - 1; i++) {
            if (history[i].status === "Offline" && history[i + 1].status === "Online") {
                let offlineTime = new Date(history[i].timestamp);
                let onlineTime = new Date(history[i + 1].timestamp);
                totalDowntime += (onlineTime - offlineTime) / (1000 * 60); // Convert to minutes
            }
        }
        return totalDowntime;
    }

    // Event listener for region filter change
    regionFilter.addEventListener("change", function () {
        fetchLiveDeviceStatus(regionFilter.value);
    });

    // Initial fetch and auto-refresh every 60 seconds
    fetchLiveDeviceStatus();
    setInterval(() => fetchLiveDeviceStatus(regionFilter.value), 60000); // Auto-refresh every 60 seconds
});













document.addEventListener("DOMContentLoaded", function () {
    const regionFilter = document.getElementById("regionFilter");
    const summaryElement = document.getElementById("summary");
    const deviceList = document.getElementById("device-list");

    // Check if elements are loaded before using them
    if (!summaryElement || !deviceList || !regionFilter) {
        console.error("One or more required elements are missing in the DOM.");
        return;
    }

    // Fetch and update the device status and summary data
    async function fetchLiveDeviceStatus(region = "global") {
        try {
            const response = await fetch(`http://localhost/api/devices/status/${region}`);
            if (!response.ok) throw new Error("Failed to fetch device status");

            const data = await response.json();
            console.log("Live Device Status Data:", data);

            updateDeviceList(data);
            updateSummary(data);
        } catch (error) {
            console.error("Error fetching live device status:", error);
            if (summaryElement) summaryElement.textContent = "Error loading device status.";
        }
    }

    // Update device list on the frontend
    function updateDeviceList(data) {
        if (!deviceList) return;

        deviceList.innerHTML = "";

        const devices = [...data.cameras, ...data.archivers]; // Combine cameras and archivers if needed

        if (devices.length === 0) {
            deviceList.innerHTML = "<li>No devices available.</li>";
            return;
        }

        devices.forEach(device => {
            const li = document.createElement("li");
            li.innerHTML = `
                <strong>${device.cameraname || device.archivername}</strong> <br>
                IP: ${device.ip_address} <br>
                Status: <span style="color:${device.status === 'Offline' ? 'red' : 'green'};">${device.status}</span>
            `;
            deviceList.appendChild(li);
        });
    }

    // Update summary data
    function updateSummary(data) {
        if (!summaryElement) return;

        let offlineDevices = 0;
        let categorizedDevices = {
            Low: [],
            Medium: [],
            High: []
        };

        const devices = [...data.cameras, ...data.archivers];

        devices.forEach(device => {
            if (device.status === "Offline") {
                offlineDevices++;
                categorizeDevice(device, categorizedDevices);
            }
        });

        summaryElement.innerHTML = `
            <strong>Total Offline Devices:</strong> ${offlineDevices} <br>
            <strong>Low Risk:</strong> ${categorizedDevices.Low.length} <br>
            <strong>Medium Risk:</strong> ${categorizedDevices.Medium.length} <br>
            <strong>High Risk:</strong> ${categorizedDevices.High.length}
        `;
    }

    // Categorize devices based on status duration or other criteria
    function categorizeDevice(device, categorizedDevices) {
        let offlineCount = device.history.filter(entry => entry.status === "Offline").length;
        let recentOfflineDuration = calculateDowntime(device.history);

        if (offlineCount > 3 || recentOfflineDuration > 120) {
            categorizedDevices.Low.push(device);
        }

        if (offlineCount >= 5 || recentOfflineDuration > 240) {
            categorizedDevices.Medium.push(device);
        }

        if (offlineCount > 7 || recentOfflineDuration > 600) {
            categorizedDevices.High.push(device);
        }
    }

    // Calculate total downtime in minutes
    function calculateDowntime(history) {
        let totalDowntime = 0;
        for (let i = 0; i < history.length - 1; i++) {
            if (history[i].status === "Offline" && history[i + 1].status === "Online") {
                let offlineTime = new Date(history[i].timestamp);
                let onlineTime = new Date(history[i + 1].timestamp);
                totalDowntime += (onlineTime - offlineTime) / (1000 * 60); // Convert to minutes
            }
        }
        return totalDowntime;
    }

    // Event listener for region filter change
    regionFilter.addEventListener("change", function () {
        fetchLiveDeviceStatus(regionFilter.value);
    });

    // Initial fetch and auto-refresh every 60 seconds
    fetchLiveDeviceStatus();
    setInterval(() => fetchLiveDeviceStatus(regionFilter.value), 60000); // Auto-refresh every 60 seconds
});
